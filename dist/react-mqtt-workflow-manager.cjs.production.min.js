"use strict";function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}Object.defineProperty(exports,"__esModule",{value:!0});var n,t=require("mqtt-pattern"),r=e(require("tiny-warning")),i=require("@reduxjs/toolkit"),o=require("react"),u=e(o),c=require("precompiled-mqtt"),s=i.createSlice({name:"@@workflowManager",initialState:{activeProcesses:[]},reducers:(n={},n["internal/ADD_PROCESS"]=function(e,n){e.activeProcesses.push(n.payload)},n["internal/REMOVE_PROCESS"]=function(e,n){e.activeProcesses=e.activeProcesses.filter((function(e){return e!==n.payload}))},n)}),a=s.name,l=s.actions["internal/ADD_PROCESS"],f=s.actions["internal/REMOVE_PROCESS"],d=s.reducer,v=/^(([\\+#]{1}|[^\\+#]*)\/)?(([\\+#]{1}|[^\\+#]*)\/{1})*(([\\+#]{1}|[^\\+#]*))$/,p=function(e){return v.test(e)},b=function(e,n,t){return function(e){var n=Array.isArray(e)?e.every((function(e){return p(e)})):p(e);return n||r(!1),n}(e)&&function(e){var n=null!==e;return n||r(!1),n}(n)&&function(e){return(null==e?void 0:e.connected)||r(!1),null==e?void 0:e.connected}(t)},_=function(){function e(){this._setInstance(this),this.subscribe=this.subscribe.bind(this)}var n=e.prototype;return n._setInstance=function(n){e._instance||(e._instance=n)},n._onMessageArrived=function(n){return function(o,u){if(function(e){try{JSON.parse(e)}catch(e){return!1}return!0}(u.toString())){if([n].flat().some((function(e){return t.matches(e,o)}))){var c,s,l=e._store,f=null==l?void 0:l.dispatch,d=JSON.parse(u.toString());f(function(e,n){return i.createAction(a+"/external/"+e)(n)}((null==d||null==(c=d.props)?void 0:c.action)||"",(null==d||null==(s=d.props)?void 0:s.result)||{}))}}else r(!1)}},e.getInstance=function(){return Object.freeze(e._instance)},e.setMqttClient=function(e){this._client=e},e.getStore=function(){return this._store},n.setStore=function(n){e._store=n},n.getMqttClient=function(){return e._client},n.subscribe=function(n,r){void 0===r&&(r={});var i=this.getMqttClient(),o=e._store;if(b(n,o,i)){var u=null==o?void 0:o.dispatch;[n].flat().forEach((function(e){var n=t.exec("/process/+processId/am/create",e),r=(null==n?void 0:n.processId)||"";r&&u(l(r))})),null==i||i.subscribe(n,r),null==i||i.on("message",this._onMessageArrived(n))}},n.unsubscribe=function(n){var t=this.getMqttClient(),r=e._store;if(b(n,r,t)){var i=null==r?void 0:r.dispatch,o=[n].flat();null==t||t.unsubscribe(n),o.forEach((function(e){i(f(e))}))}},e}();_._client=null,_._store=null,_._instance=new _;var h=o.createContext(void 0),S=h.Provider,g=_.getInstance();exports.WorkflowManager=function(e){var n=e.brokerUrl,t=void 0===n?"":n,i=e.options,s=e.children,a=o.useState(null),l=a[0],f=a[1],d=o.useState("offline"),v=d[0],p=d[1],b=o.useState(null),h=b[0],g=b[1],M=o.useCallback((function(){if(!l)try{var e=c.connect(t,i);e.on("connect",(function(){p("connected")})),e.on("end",(function(){p("offline")})),e.on("offline",(function(){p("offline")})),e.on("error",(function(){p("error"),r(!1)})),e.on("reconnect",(function(){p("reconnecting")})),f(e),_.setMqttClient(e)}catch(e){p("error"),g(e),r(!1)}}),[t,i,l]);o.useEffect((function(){M()}),[M]);var m=o.useMemo((function(){return{client:l,status:v,error:h}}),[l,v,h]);return u.createElement(S,{value:m},s)},exports.WorkflowManagerConfig=g,exports.useMqtt=function(){var e=o.useContext(h);return e||r(!1),e},exports.useSubscribe=function(){return o.useMemo((function(){return g.subscribe}),[])},exports.useUnsubscribe=function(){return o.useMemo((function(){return g.unsubscribe}),[])},exports.workflowManagerReducer=d;
//# sourceMappingURL=react-mqtt-workflow-manager.cjs.production.min.js.map
